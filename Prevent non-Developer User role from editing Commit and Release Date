import com.opensymphony.workflow.InvalidInputException
import com.atlassian.jira.component.ComponentAccessor
import com.atlassian.jira.issue.Issue
import com.atlassian.jira.security.roles.ProjectRoleManager
import com.atlassian.jira.user.ApplicationUser


def issue = issue as Issue

def targetProjectKey = "EARTH"
def requiredRoleName = "Developers"
def fieldsToCheck = ["Commit Date", "Release Date"]

if (issue.projectObject.key != targetProjectKey) {
    return // Exit if not the target project
}

def currentUser = ComponentAccessor.jiraAuthenticationContext.loggedInUser as ApplicationUser
def changeHistoryManager = ComponentAccessor.changeHistoryManager
def projectRoleManager = ComponentAccessor.getComponent(ProjectRoleManager)

def changedFields = fieldsToCheck.any { fieldName ->
    !changeHistoryManager.getChangeItemsForField(issue, fieldName).empty
}

if (changedFields) {
    def developersRole = projectRoleManager.getProjectRole(requiredRoleName)
    
    if (developersRole && !projectRoleManager.isUserInProjectRole(currentUser, developersRole, issue.projectObject)) {
        throw new InvalidInputException(
            "Only users in the *${requiredRoleName}* role can update Commit Date or Release Date fields."
        )
    }
}
