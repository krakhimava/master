import com.atlassian.jira.component.ComponentAccessor
import com.atlassian.jira.issue.Issue
import com.atlassian.jira.issue.label.LabelManager
import java.time.LocalDate
import java.time.format.DateTimeFormatter


def targetIssueType = "Budget planning"
def targetStatus = "Approved"
def labelPrefix = "approved:"

def issue = issue as Issue
def labelManager = ComponentAccessor.getComponent(LabelManager)
def currentUser = ComponentAccessor.jiraAuthenticationContext.loggedInUser

if (!issue || !labelManager) {
    log.error("Script cannot run.")
    return
}

if (issue.issueType?.name == targetIssueType && issue.status?.name == targetStatus) {

    // Format today's date
    def today = LocalDate.now().format(DateTimeFormatter.ISO_DATE)
    def labelValue = "${labelPrefix}${today}"

    // Add the label if it's not already on the issue
    def existingLabels = labelManager.getLabels(issue.id)
    def labelExists = existingLabels.find { it.getLabel() == labelValue }

    if (!labelExists) {
        labelManager.addLabel(currentUser, issue.id, labelValue, false)
        log.info("Added label '${labelValue}' to issue ${issue.key}")
    } else {
        log.debug("Label '${labelValue}' already exists on issue ${issue.key}")
    }
}
