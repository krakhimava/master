import com.atlassian.jira.component.ComponentAccessor
import com.atlassian.jira.security.groups.GroupManager
import com.onresolve.jira.groovy.user.FormField

def targetProjectKey = "NOLIA"
def allowedIssueType = "Bug"

def issueContext = issue
def project = issueContext?.projectObject
def issueTypeName = issueContext?.issueType?.name

if (!project || project.key != targetProjectKey || issueTypeName != allowedIssueType) {
    return
}

def currentUser = ComponentAccessor.jiraAuthenticationContext.loggedInUser
def groupManager = ComponentAccessor.getComponent(GroupManager)

if (!currentUser) {
    return
}

FormField environmentField = getFieldByName("Environment")
FormField targetReleaseField = getFieldByName("Target Release")
FormField reportedByTeamField = getFieldByName("Reported By Team")
FormField priorityField = getFieldByName("Priority")

if (environmentField && !environmentField.getValue()) {
    environmentField.setFormValue(
        """Browser:
OS:
Steps to Reproduce:
Expected Result:
Actual Result:
"""
    )
}

def priority = priorityField?.getValue()
def priorityName = priority?.name

if (priorityName && targetReleaseField && !targetReleaseField.getValue()) {
    switch (priorityName) {
        case "Highest":
        case "High":
            targetReleaseField.setFormValue("Next Hotfix")
            break
        default:
            targetReleaseField.setFormValue("Next Minor Release")
    }
}

def userGroups = groupManager.getGroupNamesForUser(currentUser) ?: []
def inferredTeam = "General QA"

if (userGroups.any { it.toLowerCase().contains("mobile") }) {
    inferredTeam = "Mobile QA"
} else if (userGroups.any { it.toLowerCase().contains("backend") }) {
    inferredTeam = "Backend QA"
} else if (userGroups.any { it.toLowerCase().contains("frontend") }) {
    inferredTeam = "Frontend QA"
}

if (reportedByTeamField && !reportedByTeamField.getValue()) {
    reportedByTeamField.setFormValue(inferredTeam)
}
